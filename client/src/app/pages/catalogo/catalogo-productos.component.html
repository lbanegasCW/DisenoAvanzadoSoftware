<div class="bg-white shadow">
  <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold text-gray-900" i18n="@@catalogo.title">
      CatÃ¡logo de productos
    </h1>
  </div>
</div>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <div *ngIf="loading()" class="text-gray-600 mb-4" i18n="@@catalogo.loading">Cargandoâ€¦</div>
  <div *ngIf="errorMsg()" class="mb-4 rounded border border-red-300 bg-red-50 p-3 text-red-900">
    {{ errorMsg() }}
  </div>

  <!-- Layout: Sidebar izquierda (filtros) | Contenido -->
  <div class="grid grid-cols-12 gap-6" *ngIf="!loading()">

    <!-- Sidebar filtros (izquierda) -->
    <aside class="col-span-12 md:col-span-3">
      <!-- BÃºsqueda -->
      <div class="mb-4">
        <input
          type="search"
          class="w-full border rounded-md px-3 py-2 text-gray-600"
          placeholder="Buscar producto, marca, cÃ³digoâ€¦"
          i18n-placeholder="@@catalogo.placeholder_buscar"
          [ngModel]="texto()"
          (ngModelChange)="texto.set($event)" />
      </div>

      <!-- Rubros -->
      <div class="mb-6 border rounded-lg p-3 bg-white">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-medium text-black" i18n="@@catalogo.heading_rubros">Rubros</h2>
          <button class="text-sm text-blue-700 hover:underline" *ngIf="rubroSel()" (click)="limpiarRubro()" i18n="@@catalogo.btn_limpiar_rubro">Limpiar</button>
        </div>
        <ul class="max-h-64 overflow-auto space-y-1">
          <li *ngFor="let r of rubros()">
            <button
              class="w-full flex items-center justify-between px-2 py-1 rounded hover:bg-blue-50 border"
              [class.border-blue-400]="rubroSel()===r.id"
              (click)="setRubro(r.id)">
              <span class="text-left truncate text-gray-600">{{ r.nombre }}</span>
              <span class="text-xs ml-2 rounded px-2 py-0.5 border bg-gray-50">{{ r.count }}</span>
            </button>
          </li>
        </ul>
      </div>

      <!-- CategorÃ­as -->
      <div class="mb-6 border rounded-lg p-3 bg-white">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-medium text-black" i18n="@@catalogo.heading_categorias">CategorÃ­as</h2>
          <button class="text-sm text-blue-700 hover:underline" *ngIf="categoriaSel()" (click)="limpiarCategoria()" i18n="@@catalogo.btn_limpiar_categoria">Limpiar</button>
        </div>
        <ul class="max-h-64 overflow-auto space-y-1">
          <li *ngFor="let c of categorias()">
            <button
              class="w-full flex items-center justify-between px-2 py-1 rounded hover:bg-blue-50 border"
              [class.border-blue-400]="categoriaSel()===c.id"
              (click)="setCategoria(c.id)">
              <span class="text-left truncate text-gray-600">{{ c.nombre }}</span>
              <span class="text-xs ml-2 rounded px-2 py-0.5 border bg-gray-50">{{ c.count }}</span>
            </button>
          </li>
        </ul>
        <div class="text-xs text-gray-500 mt-2" *ngIf="rubroSel()" i18n="@@catalogo.info_categorias_filtradas">Mostrando categorÃ­as del rubro seleccionado.</div>
      </div>
    </aside>

    <!-- Contenido -->
    <section class="col-span-12 md:col-span-9">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm text-gray-600">
          <ng-container i18n="@@catalogo.count_resultados">{totalResultados, plural,
            =0 {0 resultados}
            =1 {1 resultado}
            other {# resultados}
          }</ng-container>
          <span *ngIf="rubroSel()" i18n="@@catalogo.badge_rubro_filtrado"> Â· Rubro filtrado</span>
          <span *ngIf="categoriaSel()" i18n="@@catalogo.badge_categoria_filtrada"> Â· CategorÃ­a filtrada</span>
        </div>
        <div class="flex items-center gap-2">
          <button class="text-sm px-2 py-1 rounded border hover:bg-gray-50 text-gray-600"
                  (click)="texto.set(''); limpiarCategoria(); limpiarRubro()"
                  i18n="@@catalogo.btn_limpiar_todo">
            Limpiar todo
          </button>

          <!-- abre el drawer -->
          <button class="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-50 text-gray-600"
                  (click)="toggleCart()">
            <ng-container i18n="@@catalogo.btn_ver_carrito">Ver carrito</ng-container> ({{ cart.count() }})
          </button>
        </div>
      </div>

      <div *ngIf="productos().length; else sinResultados"
           class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

        <div *ngFor="let p of productos(); trackBy: track"
             class="border rounded-lg p-3 bg-white">
          <div class="flex gap-3">
            <img *ngIf="p.imagen" [src]="'assets/images/' + p.imagen"
                 alt=""
                 class="w-16 h-16 object-contain bg-gray-50 rounded">
            <div class="flex-1">
              <div class="font-semibold text-gray-900">{{ p.nomProducto }}</div>
              <div class="text-xs text-gray-500" *ngIf="p.descProducto">{{ p.descProducto }}</div>
              <div class="text-xs text-gray-500 mt-1 flex gap-2 flex-wrap">
                <span class="inline-block px-2 py-0.5 border rounded">EAN: {{ p.codBarra }}</span>
                <span *ngIf="p.nomMarca" class="inline-block px-2 py-0.5 border rounded">{{ p.nomMarca }}</span>
                <span class="inline-block px-2 py-0.5 border rounded">{{ p.nomRubro }}</span>
                <span class="inline-block px-2 py-0.5 border rounded">{{ p.nomCategoria }}</span>
              </div>
            </div>
          </div>

          <!-- Agregar/Quitar: abre el drawer cuando agrega -->
          <div class="mt-3 flex justify-end">
            @if (cart.has(p.codBarra)) {
              <button
                class="px-3 py-1.5 rounded-lg border text-sm transition text-black bg-red-50 border-red-300"
                (click)="onToggleCartFor(p.codBarra)"
                i18n="@@catalogo.btn_quitar">Quitar</button>
            } @else {
              <button
                class="px-3 py-1.5 rounded-lg border text-sm transition text-white bg-blue-600 hover:bg-blue-700"
                (click)="onToggleCartFor(p.codBarra)"
                i18n="@@catalogo.btn_agregar">Agregar</button>
            }
          </div>
        </div>

      </div>

      <ng-template #sinResultados>
        <div class="text-gray-500" i18n="@@catalogo.sin_resultados">No hay productos que coincidan con los filtros.</div>
      </ng-template>
    </section>
  </div>
</div>

<!-- Backdrop + Drawer carrito -->
<!-- Backdrop -->
<div
  class="fixed inset-0 bg-black/40 z-40 transition-opacity"
  *ngIf="cartOpen()"
  (click)="closeCart()">
</div>

<!-- Drawer -->
<div
  class="fixed top-0 right-0 h-full w-full sm:w-[28rem] bg-white z-50 shadow-2xl transform transition-transform duration-300"
  [class.translate-x-full]="!cartOpen()"
  [class.translate-x-0]="cartOpen()"
  role="dialog"
  aria-label="Carrito"
  i18n-aria-label="@@catalogo.aria_carrito">

  <!-- Header -->
  <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
    <h2 class="text-lg font-semibold text-black"><ng-container i18n="@@catalogo.drawer_title">Tu carrito</ng-container> ({{ cart.count() }})</h2>
    <button class="p-2 rounded hover:bg-gray-100" (click)="closeCart()" aria-label="Cerrar" i18n-aria-label="@@catalogo.aria_cerrar">âœ•</button>
  </div>

  <!-- Body -->
  <div class="p-4 overflow-y-auto h-[calc(100vh-9rem)]">
    <div *ngIf="!cart.count()" class="text-sm text-gray-500" i18n="@@catalogo.drawer_vacio">No agregaste productos.</div>

    <ul class="divide-y" *ngIf="cart.count()">
      <li *ngFor="let p of seleccionados()" class="py-3 flex items-center gap-3">
        <img *ngIf="p.imagen" [src]="'assets/images/' + p.imagen"
             class="w-12 h-12 object-contain bg-gray-50 rounded" alt="" />
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium truncate text-black">{{ p.nomProducto }}</div>
          <div class="text-xs text-gray-500 truncate">EAN: {{ p.codBarra }}</div>
          <div class="text-xs text-gray-500 truncate" *ngIf="p.nomMarca">{{ p.nomMarca }}</div>
        </div>
        <button class="text-xs px-2 py-1 rounded border hover:bg-gray-50 text-black"
                (click)="cart.remove(p.codBarra)"
                i18n="@@catalogo.drawer_btn_quitar">
          Quitar
        </button>
      </li>
    </ul>
  </div>

  <!-- Footer -->
  <div class="sticky bottom-0 bg-white border-t px-4 py-3">
    <div class="flex items-center justify-start gap-2">
      <button class="px-3 py-2 rounded-lg border hover:bg-gray-50 text-black" (click)="cart.clear()" *ngIf="cart.count()" i18n="@@catalogo.btn_vaciar">Vaciar</button>
      <a class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white"
         [class.pointer-events-none]="!cart.count()"
         [attr.aria-disabled]="!cart.count()"
         [routerLink]="['/comparador']"
         i18n="@@catalogo.btn_comparar">
          Comparar
      </a>
    </div>
  </div>
</div>

<!-- BotÃ³n flotante para abrir (mÃ³vil/desktop) -->
<button
  class="fixed bottom-5 right-5 z-50 rounded-full shadow-lg border bg-white px-4 py-3 flex items-center gap-2 hover:bg-gray-50"
  (click)="toggleCart()"
  aria-label="Ver carrito"
  i18n-aria-label="@@catalogo.aria_ver_carrito">
  ðŸ›’ <span class="text-sm font-medium text-gray-600">{{ cart.count() }}</span>
</button>
